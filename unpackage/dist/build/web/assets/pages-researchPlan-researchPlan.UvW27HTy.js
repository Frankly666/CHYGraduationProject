import{r as e,R as l,T as t,G as a,K as o,D as s,o as n,c as r,w as c,a as i,d as u,F as d,e as p,B as f,b as m,t as g,E as v,q as y,v as h,s as _,O as k,g as b,x as w,n as x,i as $,j as C,I as S,k as j,y as I,U as T,V as D,W as O,J as P,X as E}from"./index-E3agI9Tn.js";import{m as A,r as z,_ as N}from"./marked.esm.CWmrkk8-.js";import{e as F}from"./pdf-export.BKZ-eH5L.js";import{c as J}from"./research-plan.CgVzqYui.js";import{_ as V}from"./_plugin-vue_export-helper.BCo6x5W8.js";const B="sk-JWuFVaV252ndCTXc3Q8lvkVP7vMomFeySnJxx6bbT1PMoEst",M=V({__name:"ResearchPlanGenerator",props:{graphData:{type:Object,default:null},embedded:{type:Boolean,default:!1}},emits:["complete","cancel"],setup(E,{emit:V}){const M=E,H=[{title:"基本信息"},{title:"方案框架"},{title:"完整方案"}],L=e(0),R=l({topic:"",objective:"",keywords:[],templateType:"experimental"}),U=e(null!==M.graphData),W=e(""),q=e=>{if(console.log("关键词输入变化:",W.value),W.value.includes(",")){const e=W.value.split(",").map((e=>e.trim())).filter((e=>e));console.log("添加关键词数组:",e),R.keywords.push(...e),W.value="",le()}},G=()=>{if(console.log("关键词输入框失焦:",W.value),W.value.trim()){const e=W.value.trim();console.log("失焦添加关键词:",e),R.keywords.push(e),W.value="",le()}},X=e=>{if(console.log("关键词输入确认:",W.value),W.value.trim()){const e=W.value.trim();console.log("确认添加关键词:",e),R.keywords.push(e),W.value="",le()}},Y=["实验研究","调查研究","案例研究","文献综述","行动研究"],K=e(0),Q=["experimental","survey","case-study","literature-review","action-research"],Z=e=>{K.value=e.detail.value,R.templateType=Q[e.detail.value],le()},ee=e(!1),le=()=>{console.log("验证表单:",R),ee.value=!!R.topic&&!!R.objective&&R.keywords.length>0,console.log("验证结果:",ee.value)};t((()=>R.topic),(()=>le())),t((()=>R.objective),(()=>le()));const te=e=>{U.value=e.detail.value},ae=async()=>{var e,l;try{if(0===L.value){if(y({title:"正在生成框架...",mask:!0}),console.log("开始生成框架，表单数据:",R),!ee.value)return h(),void _({title:"请完成所有必填项",icon:"none"});if(await re(),!ne.value||ne.value.error&&!Object.keys(ne.value).some((e=>e.startsWith("section"))))return h(),void k({title:"生成失败",content:(null==(e=ne.value)?void 0:e.error)||"生成框架失败，请重试",showCancel:!1});h()}else if(1===L.value){if(y({title:"正在生成完整方案...",mask:!0}),await ve(),!ge.value||ge.value.error)return h(),void k({title:"生成失败",content:(null==(l=ge.value)?void 0:l.error)||"生成方案内容失败，请重试",showCancel:!1});h()}L.value<H.length-1&&L.value++}catch(t){console.error("步骤切换失败:",t),h(),_({title:"操作失败: "+t.message,icon:"none"})}},oe=()=>{L.value>0&&L.value--},se=e(!1),ne=e(null),re=async()=>{try{se.value=!0;const e=await(async e=>{var l;try{if(console.log("开始生成研究方案框架，参数:",JSON.stringify(e)),!e.topic||!e.objective||!e.keywords||0===e.keywords.length)throw console.error("生成研究方案框架参数不完整:",e),new Error("参数不完整，请确保填写了研究主题、目标和至少一个关键词");const n=[{role:"system",content:"你是一个专业的教育研究方案生成助手。请基于用户提供的研究主题、目标和关键词，\n生成一个科学合理的研究方案框架。框架应包括以下部分：\n1. 研究背景与意义\n2. 研究目标和问题\n3. 文献综述概要\n4. 研究方法选择\n5. 数据收集方案\n6. 数据分析方法\n7. 预期研究成果\n8. I实施计划和时间表\n\n请确保研究方案框架符合学术规范，并具有可操作性。根据研究主题和目标的特点，调整框架内容。"},{role:"user",content:`请根据以下信息生成教育研究方案框架：\n研究主题：${e.topic}\n研究目标：${e.objective}\n关键词：${e.keywords.join("、")}\n方案类型：${e.templateType}\n\n请仅生成框架结构，不需要详细内容。返回JSON格式，包含每个章节的标题和简短说明。`}];console.log("准备发送API请求...");const r={model:"moonshot-v1-32k",messages:n,temperature:.3};console.log("请求体:",JSON.stringify(r));try{const e=await fetch("https://api.moonshot.cn/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${B}`,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!e.ok){const a=await e.text();let o;console.error("API响应错误:",{status:e.status,statusText:e.statusText,responseText:a});try{o=JSON.parse(a)}catch(t){o={error:{message:a||"未知错误"}}}throw new Error((null==(l=null==o?void 0:o.error)?void 0:l.message)||`API请求失败: ${e.status} ${e.statusText}`)}const s=await e.json();console.log("生成研究方案框架成功, 状态:",e.status);try{if(!(s.choices&&s.choices[0]&&s.choices[0].message&&s.choices[0].message.content))throw console.error("API返回结果格式不正确:",s),new Error("API返回结果格式不正确");const e=s.choices[0].message.content;console.log("AI返回的原始数据长度:",e.length,"字符");const l=e.match(/\{[\s\S]*\}/),t=l?l[0]:e;console.log("提取的JSON文本:",t.substring(0,100)+"...");try{const e=JSON.parse(t);return console.log("解析成功，包含章节数:",Object.keys(e).length),e}catch(a){return console.error("JSON解析失败，尝试包装为有效JSON格式"),{error:null,section1:{title:"研究背景与意义",description:"描述研究的背景、意义和现实需求。"},section2:{title:"研究目标和问题",description:"明确研究目标和待解决的主要问题。"},section3:{title:"文献综述",description:"相关研究文献和理论基础的概述。"},section4:{title:"研究方法",description:"研究采用的方法和步骤。"},section5:{title:"数据收集方案",description:"数据收集的方式、工具和过程。"},section6:{title:"数据分析方法",description:"数据处理和分析的方法。"},section7:{title:"预期研究成果",description:"研究可能产生的成果和价值。"},section8:{title:"实施计划",description:"研究的具体实施计划和时间表。"},rawContent:e}}}catch(o){return console.error("解析AI返回结果失败:",o),{error:"解析返回结果失败",rawContent:s.choices[0].message.content,section1:{title:"研究背景与意义",description:"描述研究的背景、意义和现实需求。"},section2:{title:"研究目标和问题",description:"明确研究目标和待解决的主要问题。"}}}}catch(s){return console.error("API请求错误:",s),{error:`API请求错误: ${s.message}`,section1:{title:"研究背景与意义",description:"描述研究的背景、意义和现实需求。"},section2:{title:"研究目标和问题",description:"明确研究目标和待解决的主要问题。"}}}}catch(n){return console.error("生成研究方案框架失败:",n),{error:`生成框架失败: ${n.message}`,section1:{title:"研究背景与意义",description:"描述研究的背景、意义和现实需求。"},section2:{title:"研究目标和问题",description:"明确研究目标和待解决的主要问题。"}}}})({topic:R.topic,objective:R.objective,keywords:R.keywords,templateType:R.templateType});ne.value=e}catch(e){console.error("生成框架失败:",e),ne.value={error:"生成框架失败: "+e.message}}finally{se.value=!1}},ce=e(null),ie=e(null),ue=e(""),de=e(""),pe=()=>{ce.value.close()},fe=()=>{ie.value&&ne.value&&(ne.value[ie.value]={title:ue.value,description:de.value}),ce.value.close()},me=e(!1),ge=e({content:"",framework:null}),ve=async()=>{try{me.value=!0;const e=U.value?M.graphData:null,l=await(async(e,l,t=null)=>{var a;try{console.log("开始填充研究方案内容");const o=[{role:"system",content:"你是一个专业的教育研究方案生成助手。现在用户提供了一个研究方案框架，请基于这个框架和相关知识，\n填充生成一个完整的教育研究方案。内容应包括详细的研究方法、实施步骤、数据分析方法等。请确保内容科学合理，\n符合教育研究的规范，并具有可操作性。"},{role:"user",content:`请根据以下框架和信息，生成完整的教育研究方案：\n研究主题：${l.topic}\n研究目标：${l.objective}\n关键词：${l.keywords.join("、")}\n\n研究方案框架：\n${JSON.stringify(e,null,2)}\n\n${t?`相关知识图谱数据：${JSON.stringify(t,null,2)}`:""}\n\n请为每个章节填充具体内容，内容应科学合理，详细可行。返回完整的研究方案，格式为Markdown。`}],s=await fetch("https://api.moonshot.cn/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${B}`,"Content-Type":"application/json"},body:JSON.stringify({model:"moonshot-v1-32k",messages:o,temperature:.4})});if(!s.ok){const e=await s.json();throw console.error("填充研究方案内容错误:",e),new Error((null==(a=null==e?void 0:e.error)?void 0:a.message)||"填充研究方案内容失败")}const n=await s.json();return console.log("填充研究方案内容成功"),{content:n.choices[0].message.content,framework:e}}catch(o){throw console.error("填充研究方案内容失败:",o),o}})(ne.value,R,e);ge.value=l}catch(e){console.error("生成完整方案失败:",e),ge.value={error:"生成完整方案失败: "+e.message}}finally{me.value=!1}},ye=a((()=>{if(!ge.value.content)return"";try{console.log("原始内容前50个字符:",ge.value.content.substring(0,50));let e=ge.value.content;e=e.replace(/^[\s`]{0,3}markdown#?.*?\n/i,""),e=e.replace(/```markdown#?/gi,""),e=e.replace(/```\w*/gi,""),e=e.replace(/```/g,""),e=e.replace(/^['"`]|['"`]$/g,""),e=e.replace(/^(#{1,6})([^\s])/gm,"$1 $2"),e=e.replace(/^([*\-+])([^\s])/gm,"$1 $2"),e=e.replace(/^(\d+\.)([^\s])/gm,"$1 $2"),e=e.replace(/\n([^#\s\-\*\d])/g,"\n\n$1").replace(/([^\n])\n(#{1,6})/g,"$1\n\n$2").replace(/\n([*\-+])/g,"\n\n$1").replace(/\n{3,}/g,"\n\n"),console.log("预处理后内容前50个字符:",e.substring(0,50)),console.log("预处理后内容长度:",e.length),A.setOptions({gfm:!0,breaks:!0,headerIds:!0,mangle:!1,pedantic:!1,sanitize:!1,smartLists:!0,smartypants:!0});const l=A(e);return console.log("HTML渲染后长度:",l.length),l.replace(/<h1/g,'<h1 class="plan-h1"').replace(/<h2/g,'<h2 class="plan-h2"').replace(/<h3/g,'<h3 class="plan-h3"').replace(/<h4/g,'<h4 class="plan-h4"').replace(/<h5/g,'<h5 class="plan-h5"').replace(/<h6/g,'<h6 class="plan-h6"').replace(/<p>/g,'<p class="plan-p">').replace(/<ul>/g,'<ul class="plan-ul">').replace(/<ol>/g,'<ol class="plan-ol">').replace(/<li>/g,'<li class="plan-li">').replace(/<pre>/g,'<pre class="plan-pre">').replace(/<code>/g,'<code class="plan-code">')}catch(e){return console.error("Markdown渲染失败:",e),`<pre style="white-space: pre-wrap; word-wrap: break-word; padding: 16px; background: #f5f5f5; border-radius: 4px; font-family: monospace;">${ge.value.content.replace(/```markdown#?|```\s*\w*|```/g,"").replace(/^['"]+|['"]+$/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>`}})),he=[{label:"方法论优化",value:"methodology"},{label:"文献引用增强",value:"literature"},{label:"可行性提升",value:"feasibility"},{label:"创新性增强",value:"innovation"}],_e=e(""),ke=e(!1),be=async()=>{if(_e.value&&ge.value.content)try{ke.value=!0;const e=await(async(e,l)=>{var t;try{console.log("开始优化研究方案:",l);const a=[{role:"system",content:"你是一个专业的教育研究方案优化助手。请根据用户提供的研究方案内容和优化重点，\n对研究方案进行优化和改进。优化应该保持方案的整体结构，同时提升内容的科学性、可行性和创新性。"},{role:"user",content:`请优化以下研究方案，重点关注${l.focus}方面：\n\n${e}\n\n请在保持原方案结构的基础上，提高方案的质量。返回完整的优化后方案，格式为Markdown。`}],o=await fetch("https://api.moonshot.cn/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${B}`,"Content-Type":"application/json"},body:JSON.stringify({model:"moonshot-v1-32k",messages:a,temperature:.3})});if(!o.ok){const e=await o.json();throw console.error("优化研究方案错误:",e),new Error((null==(t=null==e?void 0:e.error)?void 0:t.message)||"优化研究方案失败")}const s=await o.json();return console.log("优化研究方案成功"),s.choices[0].message.content}catch(a){throw console.error("优化研究方案失败:",a),a}})(ge.value.content,{focus:_e.value});ge.value={...ge.value,content:e}}catch(e){console.error("优化方案失败:",e),_({title:"优化方案失败: "+e.message,icon:"none"})}finally{ke.value=!1}},we=e(!1),xe=e(null),$e=async()=>{try{if(we.value=!0,y({title:"正在生成PDF...",mask:!0}),"undefined"==typeof document)throw new Error("当前不是Web环境，无法导出PDF");console.log("准备导出PDF...");const a=document.createElement("div");a.className="plan-display export-container",a.style.width="100%",a.style.fontFamily="PingFang SC, Microsoft YaHei, sans-serif",a.style.backgroundColor="#ffffff",a.style.boxSizing="border-box",a.style.padding="30px",a.style.lineHeight="1.6",a.style.color="#333333";const o=document.createElement("div");o.className="plan-header",o.style.textAlign="center",o.style.marginBottom="30px";const s=document.createElement("div");s.className="plan-title",s.textContent=R.topic,s.style.fontSize="26px",s.style.fontWeight="bold",s.style.marginBottom="15px",o.appendChild(s);const n=document.createElement("div");n.className="plan-meta",n.textContent=`关键词: ${R.keywords.join("、")}`,n.style.fontSize="14px",n.style.color="#666",o.appendChild(n);const r=document.createElement("div");r.style.marginTop="20px",r.style.marginBottom="30px",r.style.padding="15px",r.style.backgroundColor="#f8f9fa",r.style.borderRadius="6px",r.style.textAlign="left";const c=document.createElement("div");c.textContent="研究目标:",c.style.fontWeight="bold",c.style.marginBottom="8px",r.appendChild(c);const i=document.createElement("div");i.textContent=R.objective||"无",i.style.color="#333",r.appendChild(i),o.appendChild(r),a.appendChild(o);const u=document.createElement("div");u.className="plan-content",u.style.fontSize="15px",u.style.lineHeight="1.6",u.style.textAlign="left";try{u.innerHTML=(e=>{if(!e)return"";try{A.setOptions({gfm:!0,breaks:!0,headerIds:!0,mangle:!1,pedantic:!1,sanitize:!1,smartLists:!0,smartypants:!0});let l=e;l=l.replace(/^[\s`]{0,3}markdown#?.*?\n/i,""),l=l.replace(/```markdown#?/gi,""),l=l.replace(/```\w*/gi,""),l=l.replace(/```/g,""),l=l.replace(/^['"`]|['"`]$/g,""),l=l.replace(/^(#{1,6})([^\s])/gm,"$1 $2"),l=l.replace(/^([*\-+])([^\s])/gm,"$1 $2"),l=l.replace(/^(\d+\.)([^\s])/gm,"$1 $2"),l=l.replace(/\n([^#\s\-\*\d])/g,"\n\n$1").replace(/([^\n])\n(#{1,6})/g,"$1\n\n$2").replace(/\n([*\-+])/g,"\n\n$1").replace(/\n{3,}/g,"\n\n");return A(l).replace(/<h1/g,'<h1 style="font-size:24px;font-weight:bold;margin:24px 0 16px;color:#333;border-bottom:1px solid #eee;padding-bottom:8px;"').replace(/<h2/g,'<h2 style="font-size:20px;font-weight:bold;margin:20px 0 14px;color:#333;"').replace(/<h3/g,'<h3 style="font-size:18px;font-weight:bold;margin:18px 0 12px;color:#333;"').replace(/<h4/g,'<h4 style="font-size:16px;font-weight:bold;margin:16px 0 10px;color:#333;"').replace(/<h5/g,'<h5 style="font-size:14px;font-weight:bold;margin:14px 0 8px;color:#333;"').replace(/<h6/g,'<h6 style="font-size:13px;font-weight:bold;margin:12px 0 6px;color:#333;"').replace(/<p>/g,'<p style="margin:12px 0;line-height:1.6;color:#333;">').replace(/<ul>/g,'<ul style="margin:12px 0;padding-left:24px;">').replace(/<ol>/g,'<ol style="margin:12px 0;padding-left:24px;">').replace(/<li>/g,'<li style="margin:6px 0;line-height:1.5;">').replace(/<pre/g,'<pre style="background-color:#f5f5f5;padding:12px;border-radius:5px;overflow-x:auto;margin:16px 0;"').replace(/<code/g,'<code style="background-color:#f0f0f0;padding:2px 4px;border-radius:3px;font-family:monospace;font-size:0.9em;"')}catch(l){return console.error("Markdown转HTML失败:",l),`<div style="white-space:pre-wrap;padding:16px;background:#f5f5f5;border-radius:4px;font-family:monospace;line-height:1.5;">${e.replace(/```markdown#?|```\s*\w*|```/g,"").replace(/^['"]+|['"]+$/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>`}})(ge.value.content)}catch(e){console.error("Markdown转HTML失败:",e);let l=ge.value.content.replace(/```markdown#?|```\s*\w*|```/g,"").replace(/^['"]+|['"]+$/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;");u.innerHTML=`<pre style="white-space: pre-wrap; word-wrap: break-word; padding: 16px; background: #f5f5f5; border-radius: 4px; font-family: monospace;">${l}</pre>`}Array.from(u.querySelectorAll("h1, h2, h3, h4, h5, h6")).forEach((e=>{e.style.pageBreakAfter="avoid",e.style.pageBreakBefore="auto"})),Array.from(u.querySelectorAll("p")).forEach((e=>{e.style.pageBreakInside="avoid"})),Array.from(u.querySelectorAll("ul, ol")).forEach((e=>{e.style.pageBreakInside="auto"})),a.appendChild(u);const d=document.createElement("div");d.className="plan-footer",d.style.marginTop="40px",d.style.paddingTop="15px",d.style.borderTop="1px solid #f0f0f0",d.style.textAlign="center",d.style.fontSize="12px",d.style.color="#999";const p=document.createElement("div");p.textContent=`生成时间: ${Ie(new Date)}`,d.appendChild(p);const f=document.createElement("div");f.textContent="由EduResearch智能教育研究助手生成",d.appendChild(f),a.appendChild(d),console.log("导出内容准备完成");try{console.log("添加元素到DOM并准备导出..."),a.style.position="fixed",a.style.top="0",a.style.left="0",a.style.width="210mm",a.style.maxWidth="210mm",a.style.padding="20mm 20mm",a.style.boxSizing="border-box",a.style.zIndex="-1000",document.body.appendChild(a),await new Promise((e=>setTimeout(e,1e3)));const e=`${R.topic.substring(0,20)}_研究方案.pdf`;console.log("准备导出PDF，文件名:",e);const l=await F({element:a,filename:e,title:R.topic,author:"教育研究助手",margins:{top:15,right:15,bottom:20,left:15},pageSize:"a4"});if(h(),!l.success)throw new Error(l.message);_({title:"导出成功",icon:"success",duration:2e3})}catch(l){throw console.error("PDF导出失败:",l),l}finally{if(document.body.contains(a))try{document.body.removeChild(a),console.log("临时导出元素已移除")}catch(t){console.error("移除临时元素失败:",t)}}}catch(l){console.error("导出PDF过程中出错:",l),h(),k({title:"导出失败",content:`无法导出PDF: ${l.message}。您可以尝试刷新页面后重试，或复制内容到其他文档工具中。`,showCancel:!1})}finally{we.value=!1}},Ce=async()=>{try{const l=b("isLogIn"),t=b("userId");if(!l||!t)return void _({title:"请先登录再保存",icon:"none"});y({title:"正在保存...",mask:!0});const a=(e,l=500)=>null==e?"":("string"!=typeof e&&(e=String(e)),e.replace(/[\x00-\x1F\x7F-\x9F]/g,"").replace(/[\uD800-\uDFFF]/g,"").replace(/[^\u0000-\u00ff\u4e00-\u9fa5]/g,"").slice(0,l)),o=e=>Array.isArray(e)?e.map((e=>a(e,50))).filter((e=>e.length>0)).slice(0,10):[],s=e=>{if(!e)return"{}";try{const l={};Object.keys(e).forEach((t=>{"object"==typeof e[t]&&null!==e[t]&&e[t].title&&(l[t]={title:a(e[t].title,100),description:a(e[t].description,500)})}));const t=JSON.stringify(l);return JSON.parse(t),t}catch(l){return console.error("框架对象转JSON失败:",l),"{}"}},n={title:a(R.topic,100),topic:a(R.topic,100),objective:a(R.objective,500),keywords:o(R.keywords),templateType:a(R.templateType,50),frameworkStr:s(ne.value),content:a(ge.value.content,5e4),clientId:`client_${Date.now()}_${Math.random().toString(36).substring(2,10)}`};console.log("处理后的安全数据:",n),console.log("开始调用创建研究方案API...");const r=await J(n);console.log("保存成功，返回的完整方案数据:",r),Object.keys(r).forEach((e=>{console.log(`返回字段[${e}]:`,r[e])}));let c=null;r&&r._id?(c=r._id,console.log("成功获取到方案ID:",c)):r&&r.id?(c=r.id,console.log("使用替代ID字段:",c)):(c=n.clientId,console.log("使用客户端生成的备用ID:",c));try{let e=b("researchPlanHistory")||[];Array.isArray(e)||(e=[]),e.unshift({id:c,title:n.title,time:Date.now()}),e.length>10&&(e=e.slice(0,10)),w("researchPlanHistory",e),console.log("更新方案历史记录成功，当前历史:",e)}catch(e){console.error("保存方案历史记录失败:",e)}h(),_({title:"保存成功",icon:"success"}),c&&setTimeout((()=>{console.log("即将跳转到详情页，ID:",c),x({url:`/pages/researchPlanDetail/researchPlanDetail?id=${encodeURIComponent(c)}`})}),1500)}catch(l){console.error("保存研究方案失败:",l),h(),_({title:"保存失败: "+l.message,icon:"none"})}},Se=()=>{R.topic="",R.objective="",R.keywords=[],R.templateType="experimental",W.value="",K.value=0,ee.value=!1,ne.value=null,ge.value={content:"",framework:null},_e.value="",L.value=0},je=()=>{W.value.trim()&&(console.log("手动添加关键词:",W.value.trim()),R.keywords.push(W.value.trim()),W.value="",le(),_({title:"关键词已添加",icon:"none",duration:1e3}))},Ie=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`;return o((()=>{console.log("研究方案生成器组件已挂载"),le(),ce.value||(console.warn("编辑弹窗组件未正确初始化"),setTimeout((()=>{ce.value||console.warn("编辑弹窗组件延迟初始化仍然失败")}),1e3)),console.log("初始状态:",{currentStep:L.value,formData:JSON.stringify(R),isFormValid:ee.value,templateTypeIndex:K.value,graphData:M.graphData?"存在":"不存在"})})),t((()=>M.graphData),(e=>{U.value=null!==e})),(e,l)=>{const t=$,a=C,o=S,y=j,h=I,_=T,k=D,b=O,w=P,x=z(s("uni-popup"),N);return n(),r(t,{class:"research-plan-generator"},{default:c((()=>[i(t,{class:"steps-container"},{default:c((()=>[(n(),u(d,null,p(H,((e,l)=>i(t,{key:l,class:f(["step",{active:L.value>=l,complete:L.value>l}])},{default:c((()=>[i(t,{class:"step-number"},{default:c((()=>[m(g(l+1),1)])),_:2},1024),i(a,{class:"step-title"},{default:c((()=>[m(g(e.title),1)])),_:2},1024)])),_:2},1032,["class"]))),64))])),_:1}),i(t,{class:"step-content"},{default:c((()=>[0===L.value?(n(),r(t,{key:0,class:"step-form"},{default:c((()=>[i(t,{class:"form-group"},{default:c((()=>[i(a,{class:"form-label"},{default:c((()=>[m("研究主题")])),_:1}),i(o,{class:"form-input",modelValue:R.topic,"onUpdate:modelValue":l[0]||(l[0]=e=>R.topic=e),placeholder:"请输入研究主题",onInput:le,onBlur:le},null,8,["modelValue"])])),_:1}),i(t,{class:"form-group"},{default:c((()=>[i(a,{class:"form-label"},{default:c((()=>[m("研究目标")])),_:1}),i(y,{class:"form-textarea",modelValue:R.objective,"onUpdate:modelValue":l[1]||(l[1]=e=>R.objective=e),placeholder:"请描述研究目标",onInput:le,onBlur:le},null,8,["modelValue"])])),_:1}),i(t,{class:"form-group"},{default:c((()=>[i(a,{class:"form-label"},{default:c((()=>[m("关键词（多个关键词以逗号分隔）")])),_:1}),i(t,{class:"keyword-input-container"},{default:c((()=>[i(o,{class:"form-input",modelValue:W.value,"onUpdate:modelValue":l[2]||(l[2]=e=>W.value=e),placeholder:"例如：教育技术,数据挖掘,人工智能",onInput:q,onBlur:G,onConfirm:X},null,8,["modelValue"]),i(h,{class:"add-keyword-btn",onClick:je,disabled:!W.value.trim()},{default:c((()=>[m(" 添加 ")])),_:1},8,["disabled"])])),_:1}),i(t,{class:"keywords-container"},{default:c((()=>[(n(!0),u(d,null,p(R.keywords,((e,l)=>(n(),r(t,{key:l,class:"keyword-tag"},{default:c((()=>[i(a,null,{default:c((()=>[m(g(e),1)])),_:2},1024),i(a,{class:"remove-keyword",onClick:e=>(e=>{R.keywords.splice(e,1),le()})(l)},{default:c((()=>[m("×")])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1})])),_:1}),i(t,{class:"form-group"},{default:c((()=>[i(a,{class:"form-label"},{default:c((()=>[m("研究方案类型")])),_:1}),i(_,{class:"form-picker",range:Y,value:K.value,onChange:Z},{default:c((()=>[i(t,{class:"picker-text"},{default:c((()=>[m(g(K.value>=0?Y[K.value]:"请选择研究方案类型"),1)])),_:1})])),_:1},8,["value"])])),_:1}),E.graphData?(n(),r(t,{key:0,class:"form-group"},{default:c((()=>[i(b,{class:"checkbox-container"},{default:c((()=>[i(k,{checked:U.value,onChange:te},null,8,["checked"]),i(a,{class:"checkbox-label"},{default:c((()=>[m("使用已生成的知识图谱数据")])),_:1})])),_:1})])),_:1})):v("",!0),i(t,{class:"form-actions"},{default:c((()=>[i(h,{class:"primary-button",onClick:ae,disabled:!ee.value,"hover-class":"button-hover"},{default:c((()=>[m(" 下一步：生成框架 ")])),_:1},8,["disabled"])])),_:1})])),_:1})):v("",!0),1===L.value?(n(),r(t,{key:1,class:"step-framework"},{default:c((()=>[se.value?(n(),r(t,{key:0,class:"loading-container"},{default:c((()=>[i(t,{class:"loading-spinner"}),i(a,{class:"loading-text"},{default:c((()=>[m("正在生成研究方案框架...")])),_:1})])),_:1})):(n(),r(t,{key:1,class:"framework-content"},{default:c((()=>[i(a,{class:"section-title"},{default:c((()=>[m("研究方案框架")])),_:1}),ne.value.error?(n(),r(t,{key:0,class:"error-message"},{default:c((()=>[i(a,null,{default:c((()=>[m(g(ne.value.error),1)])),_:1}),i(h,{class:"retry-button",onClick:re},{default:c((()=>[m("重试")])),_:1})])),_:1})):(n(),r(t,{key:1,class:"framework-sections"},{default:c((()=>[(n(!0),u(d,null,p(ne.value,((e,l)=>(n(),r(t,{key:l,class:"framework-section"},{default:c((()=>[i(t,{class:"section-header"},{default:c((()=>[i(a,{class:"section-name"},{default:c((()=>[m(g(e.title),1)])),_:2},1024),i(a,{class:"section-edit",onClick:e=>(e=>{ie.value=e,ue.value=ne.value[e].title,de.value=ne.value[e].description,ce.value.open()})(l)},{default:c((()=>[m("编辑")])),_:2},1032,["onClick"])])),_:2},1024),i(a,{class:"section-description"},{default:c((()=>[m(g(e.description),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})),i(t,{class:"form-actions"},{default:c((()=>[i(h,{class:"secondary-button",onClick:oe},{default:c((()=>[m(" 返回上一步 ")])),_:1}),i(h,{class:"primary-button",onClick:ae,disabled:!ne.value||ne.value.error},{default:c((()=>[m(" 下一步：生成完整方案 ")])),_:1},8,["disabled"])])),_:1})])),_:1}))])),_:1})):v("",!0),2===L.value?(n(),r(t,{key:2,class:"step-complete-plan"},{default:c((()=>[me.value?(n(),r(t,{key:0,class:"loading-container"},{default:c((()=>[i(t,{class:"loading-spinner"}),i(a,{class:"loading-text"},{default:c((()=>[m("正在生成完整研究方案...")])),_:1})])),_:1})):(n(),r(t,{key:1,class:"plan-content"},{default:c((()=>[i(a,{class:"section-title"},{default:c((()=>[m("完整研究方案")])),_:1}),ge.value.error?(n(),r(t,{key:0,class:"error-message"},{default:c((()=>[i(a,null,{default:c((()=>[m(g(ge.value.error),1)])),_:1}),i(h,{class:"retry-button",onClick:ve},{default:c((()=>[m("重试")])),_:1})])),_:1})):(n(),r(t,{key:1,class:"plan-display",ref_key:"planDisplayRef",ref:xe},{default:c((()=>[i(t,{class:"plan-header"},{default:c((()=>[i(t,{class:"plan-title"},{default:c((()=>[m(g(R.topic),1)])),_:1}),i(t,{class:"plan-meta"},{default:c((()=>[i(a,null,{default:c((()=>[m("关键词: "+g(R.keywords.join("、")),1)])),_:1})])),_:1})])),_:1}),i(w,{nodes:ye.value},null,8,["nodes"]),i(t,{class:"plan-footer"},{default:c((()=>[i(a,null,{default:c((()=>[m("生成时间: "+g(Ie(new Date)),1)])),_:1}),i(a,null,{default:c((()=>[m("由EduResearch智能教育研究助手生成")])),_:1})])),_:1})])),_:1},512)),ge.value.content?(n(),r(t,{key:2,class:"optimization-controls"},{default:c((()=>[i(a,{class:"optimization-title"},{default:c((()=>[m("方案优化")])),_:1}),i(t,{class:"optimization-options"},{default:c((()=>[(n(),u(d,null,p(he,((e,l)=>i(t,{key:l,class:f(["optimization-option",{selected:_e.value===e.value}]),onClick:l=>{return t=e.value,void(_e.value=t);var t}},{default:c((()=>[i(a,null,{default:c((()=>[m(g(e.label),1)])),_:2},1024)])),_:2},1032,["class","onClick"]))),64))])),_:1}),i(h,{class:"optimize-button",onClick:be,disabled:!_e.value||ke.value},{default:c((()=>[m(g(ke.value?"正在优化...":"优化方案"),1)])),_:1},8,["disabled"])])),_:1})):v("",!0),ge.value.content?(n(),r(t,{key:3,class:"export-options"},{default:c((()=>[i(h,{class:"export-button",onClick:$e,disabled:we.value},{default:c((()=>[m(g(we.value?"导出中...":"导出为PDF"),1)])),_:1},8,["disabled"]),i(h,{class:"save-button",onClick:Ce},{default:c((()=>[m(" 保存到历史记录 ")])),_:1})])),_:1})):v("",!0),i(t,{class:"form-actions"},{default:c((()=>[i(h,{class:"secondary-button",onClick:oe},{default:c((()=>[m(" 返回上一步 ")])),_:1}),i(h,{class:"restart-button",onClick:Se},{default:c((()=>[m(" 重新开始 ")])),_:1})])),_:1})])),_:1}))])),_:1})):v("",!0)])),_:1}),i(x,{ref_key:"sectionEditPopup",ref:ce,type:"center"},{default:c((()=>[i(t,{class:"edit-popup-content"},{default:c((()=>[i(t,{class:"edit-popup-header"},{default:c((()=>[i(a,{class:"edit-popup-title"},{default:c((()=>[m("编辑"+g(ie.value?ne.value[ie.value].title:""),1)])),_:1})])),_:1}),i(t,{class:"edit-popup-body"},{default:c((()=>[i(t,{class:"form-group"},{default:c((()=>[i(a,{class:"form-label"},{default:c((()=>[m("标题")])),_:1}),i(o,{class:"form-input",modelValue:ue.value,"onUpdate:modelValue":l[3]||(l[3]=e=>ue.value=e),placeholder:"输入章节标题"},null,8,["modelValue"])])),_:1}),i(t,{class:"form-group"},{default:c((()=>[i(a,{class:"form-label"},{default:c((()=>[m("描述")])),_:1}),i(y,{class:"form-textarea",modelValue:de.value,"onUpdate:modelValue":l[4]||(l[4]=e=>de.value=e),placeholder:"输入章节描述"},null,8,["modelValue"])])),_:1})])),_:1}),i(t,{class:"edit-popup-footer"},{default:c((()=>[i(h,{class:"cancel-button",onClick:pe},{default:c((()=>[m("取消")])),_:1}),i(h,{class:"confirm-button",onClick:fe},{default:c((()=>[m("保存")])),_:1})])),_:1})])),_:1})])),_:1},512)])),_:1})}}},[["__scopeId","data-v-1ce69ed5"]]),H=V({__name:"researchPlan",setup(l){const t=e(!1),a=e(""),s=e(null),u=()=>{E({delta:1})},d=e=>{x({url:`/pages/${e}/${e}`})},p=e=>{console.log("方案生成完成:",e)},f=()=>{console.log("方案生成已取消")};return o((()=>{(()=>{try{const e=b("isLogIn"),l=b("username");e&&l?(t.value=!0,a.value=l):(t.value=!1,a.value="")}catch(e){console.error("检查登录状态时出错:",e),t.value=!1,a.value=""}})(),(()=>{try{const e=b("lastGraphData");e&&(s.value=JSON.parse(e))}catch(e){console.error("加载知识图谱数据时出错:",e),s.value=null}})()})),(e,l)=>{const o=C,v=$;return n(),r(v,{class:"research-plan-page"},{default:c((()=>[i(v,{class:"header"},{default:c((()=>[i(v,{class:"back-button",onClick:u},{default:c((()=>[i(o,{class:"back-icon"},{default:c((()=>[m("←")])),_:1}),i(o,{class:"back-text"},{default:c((()=>[m("返回")])),_:1})])),_:1}),i(o,{class:"logo"},{default:c((()=>[m("EduResearch")])),_:1}),t.value?(n(),r(v,{key:1,class:"user-info"},{default:c((()=>[i(o,null,{default:c((()=>[m(g(a.value),1)])),_:1})])),_:1})):(n(),r(v,{key:0,class:"nav-btns"},{default:c((()=>[i(o,{class:"nav-btn",onClick:l[0]||(l[0]=e=>d("logIn"))},{default:c((()=>[m("登录")])),_:1}),i(o,{class:"nav-btn primary",onClick:l[1]||(l[1]=e=>d("enroll"))},{default:c((()=>[m("注册")])),_:1})])),_:1}))])),_:1}),i(v,{class:"main-content"},{default:c((()=>[i(v,{class:"page-title"},{default:c((()=>[i(o,{class:"title-text"},{default:c((()=>[m("研究方案生成")])),_:1}),i(o,{class:"subtitle-text"},{default:c((()=>[m("基于领域结构化知识驱动的教学研究方案生成系统")])),_:1})])),_:1}),i(v,{class:"feature-description"},{default:c((()=>[i(v,{class:"feature-card"},{default:c((()=>[i(v,{class:"feature-icon"},{default:c((()=>[m("📝")])),_:1}),i(v,{class:"feature-info"},{default:c((()=>[i(o,{class:"feature-title"},{default:c((()=>[m("自动生成研究框架")])),_:1}),i(o,{class:"feature-desc"},{default:c((()=>[m("根据研究主题和目标，自动生成符合学术规范的研究方案框架")])),_:1})])),_:1})])),_:1}),i(v,{class:"feature-card"},{default:c((()=>[i(v,{class:"feature-icon"},{default:c((()=>[m("🔍")])),_:1}),i(v,{class:"feature-info"},{default:c((()=>[i(o,{class:"feature-title"},{default:c((()=>[m("智能填充研究内容")])),_:1}),i(o,{class:"feature-desc"},{default:c((()=>[m("基于框架结构，智能生成研究方法、数据收集和分析方案")])),_:1})])),_:1})])),_:1}),i(v,{class:"feature-card"},{default:c((()=>[i(v,{class:"feature-icon"},{default:c((()=>[m("📊")])),_:1}),i(v,{class:"feature-info"},{default:c((()=>[i(o,{class:"feature-title"},{default:c((()=>[m("结合知识图谱数据")])),_:1}),i(o,{class:"feature-desc"},{default:c((()=>[m("利用知识图谱数据，增强研究方案的科学性和系统性")])),_:1})])),_:1})])),_:1})])),_:1}),i(M,{"graph-data":s.value,embedded:!1,onComplete:p,onCancel:f},null,8,["graph-data"])])),_:1}),i(v,{class:"footer"},{default:c((()=>[i(o,null,{default:c((()=>[m("让教育研究更高效 © 2024")])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-3e90d92b"]]);export{H as default};
