import{r as e,K as a,a1 as l,a2 as t,s,G as r,c as o,w as c,i as n,o as u,a as d,b as i,t as p,d as m,e as f,F as v,B as k,q as w,v as _,X as g,j as y,y as h,I as b,k as $,J as S}from"./index-E3agI9Tn.js";import{a as V,u as j}from"./research-plan.CgVzqYui.js";import{_ as x}from"./_plugin-vue_export-helper.BCo6x5W8.js";const C=x({__name:"researchPlanEditor",setup(x){const C=e(!0),M=e(null),T=e(null),q=e("edit"),I=e(""),U=e(""),D={experimental:"实验研究",survey:"调查研究","case-study":"案例研究","literature-review":"文献综述","action-research":"行动研究"};a((async()=>{const e=l().query||{},a=(t?t().query:{}).id||e.id;U.value=a,a?await J(a):(C.value=!1,s({title:"缺少方案ID",icon:"none"}))}));const J=async e=>{try{C.value=!0;const l=await V(e);if(l.frameworkStr)try{l.framework=JSON.parse(l.frameworkStr)}catch(a){console.error("解析框架字符串失败:",a),l.framework={}}else l.framework||(l.framework={});M.value=l,T.value={title:l.title,objective:l.objective,keywords:[...l.keywords],content:l.content,templateType:l.templateType,framework:l.framework},C.value=!1}catch(l){console.error("加载研究方案详情失败:",l),C.value=!1,s({title:"加载失败: "+l.message,icon:"none"})}},O=()=>{I.value.trim()&&(T.value.keywords.includes(I.value.trim())||T.value.keywords.push(I.value.trim()),I.value="")},F=r((()=>{if(!T.value||!T.value.content)return"";try{let e=T.value.content;e=e.replace(/```markdown#?/gi,""),e=e.replace(/```\s*\w*/gi,""),e=e.replace(/```$/gm,""),e=e.replace(/^(#{1,6})([^\s])/gm,"$1 $2"),e=e.replace(/^([*\-+])([^\s])/gm,"$1 $2"),e=e.replace(/^(\d+\.)([^\s])/gm,"$1 $2"),e=e.replace(/^['"]+|['"]+$/g,""),e=e.replace(/^\s*markdown[#\s]*/i,""),e=e.replace(/\n([^#\s-])/g,"\n\n$1").replace(/([^\n])\n(#{1,6})/g,"$1\n\n$2").replace(/\n([\*\-+])/g,"\n\n$1").replace(/\n{3,}/g,"\n\n");const a=require("marked");a.setOptions({gfm:!0,breaks:!0,headerIds:!0,mangle:!1,pedantic:!1,sanitize:!1,smartLists:!0,smartypants:!0});return a(e).replace(/<h1/g,'<h1 class="md-h1"').replace(/<h2/g,'<h2 class="md-h2"').replace(/<h3/g,'<h3 class="md-h3"').replace(/<h4/g,'<h4 class="md-h4"').replace(/<p>/g,'<p class="md-p">').replace(/<ul>/g,'<ul class="md-ul">').replace(/<ol>/g,'<ol class="md-ol">').replace(/<li>/g,'<li class="md-li">').replace(/<pre>/g,'<pre class="md-pre">').replace(/<code>/g,'<code class="md-code">')}catch(e){return console.error("Markdown渲染失败:",e),`<pre style="white-space: pre-wrap; word-wrap: break-word; padding: 16px; background: #f5f5f5; border-radius: 4px; font-family: monospace;">${T.value.content.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>`}})),N=async()=>{if(T.value.title.trim())try{w({title:"正在保存...",mask:!0});const a={title:T.value.title,objective:T.value.objective,keywords:T.value.keywords,content:T.value.content};if(T.value.framework)try{a.frameworkStr=JSON.stringify(T.value.framework)}catch(e){console.error("转换框架为字符串失败:",e),a.frameworkStr="{}"}await j(U.value,a),_(),s({title:"保存成功",icon:"success"}),setTimeout((()=>{z()}),1500)}catch(e){console.error("保存研究方案失败:",e),_(),s({title:"保存失败: "+e.message,icon:"none"})}else s({title:"标题不能为空",icon:"none"})},z=()=>{g({delta:1})},B=e=>{if(!e)return"";const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`};return(e,a)=>{const l=n,t=y,s=h,r=b,w=$,_=S;return u(),o(l,{class:"research-plan-editor-container"},{default:c((()=>[C.value?(u(),o(l,{key:0,class:"loading-container"},{default:c((()=>[d(l,{class:"loading-spinner"}),d(t,{class:"loading-text"},{default:c((()=>[i("加载研究方案中...")])),_:1})])),_:1})):M.value?(u(),o(l,{key:2,class:"editor-content"},{default:c((()=>[d(l,{class:"editor-header"},{default:c((()=>[d(l,{class:"editor-title"},{default:c((()=>[i("编辑研究方案")])),_:1}),d(l,{class:"plan-meta"},{default:c((()=>[d(t,{class:"plan-type"},{default:c((()=>{return[i(p((e=M.value.templateType,D[e]||e)),1)];var e})),_:1}),d(t,{class:"plan-date"},{default:c((()=>[i("创建时间: "+p(B(M.value.createTime)),1)])),_:1})])),_:1})])),_:1}),d(l,{class:"form-container"},{default:c((()=>[d(l,{class:"form-section"},{default:c((()=>[d(l,{class:"form-group"},{default:c((()=>[d(t,{class:"form-label"},{default:c((()=>[i("标题")])),_:1}),d(r,{class:"form-input",modelValue:T.value.title,"onUpdate:modelValue":a[0]||(a[0]=e=>T.value.title=e),placeholder:"输入研究方案标题"},null,8,["modelValue"])])),_:1}),d(l,{class:"form-group"},{default:c((()=>[d(t,{class:"form-label"},{default:c((()=>[i("研究目标")])),_:1}),d(w,{class:"form-textarea",modelValue:T.value.objective,"onUpdate:modelValue":a[1]||(a[1]=e=>T.value.objective=e),placeholder:"描述研究目标"},null,8,["modelValue"])])),_:1}),d(l,{class:"form-group"},{default:c((()=>[d(t,{class:"form-label"},{default:c((()=>[i("关键词")])),_:1}),d(l,{class:"keywords-container"},{default:c((()=>[(u(!0),m(v,null,f(T.value.keywords,((e,a)=>(u(),o(l,{key:a,class:"keyword-tag"},{default:c((()=>[d(t,null,{default:c((()=>[i(p(e),1)])),_:2},1024),d(t,{class:"remove-keyword",onClick:e=>(e=>{T.value.keywords.splice(e,1)})(a)},{default:c((()=>[i("×")])),_:2},1032,["onClick"])])),_:2},1024)))),128)),d(l,{class:"keyword-input-container"},{default:c((()=>[d(r,{class:"keyword-input",modelValue:I.value,"onUpdate:modelValue":a[2]||(a[2]=e=>I.value=e),placeholder:"添加新关键词",onConfirm:O},null,8,["modelValue"]),d(s,{class:"add-keyword-btn",onClick:O,disabled:!I.value.trim()},{default:c((()=>[i("添加")])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})])),_:1}),d(l,{class:"form-section"},{default:c((()=>[d(l,{class:"edit-tabs"},{default:c((()=>[d(l,{class:k(["tab",{active:"edit"===q.value}]),onClick:a[3]||(a[3]=e=>q.value="edit")},{default:c((()=>[i(" 编辑 ")])),_:1},8,["class"]),d(l,{class:k(["tab",{active:"preview"===q.value}]),onClick:a[4]||(a[4]=e=>q.value="preview")},{default:c((()=>[i(" 预览 ")])),_:1},8,["class"])])),_:1}),"edit"===q.value?(u(),o(l,{key:0,class:"markdown-editor"},{default:c((()=>[d(w,{class:"editor-textarea",modelValue:T.value.content,"onUpdate:modelValue":a[5]||(a[5]=e=>T.value.content=e),placeholder:"使用Markdown格式编辑研究方案内容"},null,8,["modelValue"]),d(l,{class:"markdown-tips"},{default:c((()=>[d(t,{class:"tips-title"},{default:c((()=>[i("Markdown 快速指南:")])),_:1}),d(t,{class:"tip-item"},{default:c((()=>[i("# 标题1")])),_:1}),d(t,{class:"tip-item"},{default:c((()=>[i("## 标题2")])),_:1}),d(t,{class:"tip-item"},{default:c((()=>[i("**粗体**")])),_:1}),d(t,{class:"tip-item"},{default:c((()=>[i("*斜体*")])),_:1}),d(t,{class:"tip-item"},{default:c((()=>[i("- 无序列表项")])),_:1}),d(t,{class:"tip-item"},{default:c((()=>[i("1. 有序列表项")])),_:1})])),_:1})])),_:1})):(u(),o(l,{key:1,class:"markdown-preview"},{default:c((()=>[d(_,{class:"preview-content",nodes:F.value},null,8,["nodes"])])),_:1}))])),_:1}),d(l,{class:"form-actions"},{default:c((()=>[d(s,{class:"action-button cancel-button",onClick:z},{default:c((()=>[i(" 取消 ")])),_:1}),d(s,{class:"action-button save-button",onClick:N},{default:c((()=>[i(" 保存方案 ")])),_:1})])),_:1})])),_:1})])),_:1})):(u(),o(l,{key:1,class:"error-container"},{default:c((()=>[d(t,{class:"error-text"},{default:c((()=>[i("加载失败，研究方案不存在或已被删除")])),_:1}),d(s,{class:"back-button",onClick:z},{default:c((()=>[i("返回列表")])),_:1})])),_:1}))])),_:1})}}},[["__scopeId","data-v-a3ab2e57"]]);export{C as default};
