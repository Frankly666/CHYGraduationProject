import{r as e,K as t,a1 as a,a2 as l,g as r,s as o,x as n,G as s,c,w as i,i as d,o as p,a as u,b as g,t as m,d as f,e as y,F as h,q as v,v as w,n as k,O as x,X as b,j as _,y as $,J as S}from"./index-E3agI9Tn.js";import{a as C,b as A,d as E}from"./research-plan.CgVzqYui.js";import{e as D}from"./pdf-export.BKZ-eH5L.js";import{_ as j}from"./_plugin-vue_export-helper.BCo6x5W8.js";const T=j({__name:"researchPlanDetail",setup(j){const T=e(!0),H=e(null),P=e(""),I={experimental:"实验研究",survey:"调查研究","case-study":"案例研究","literature-review":"文献综述","action-research":"行动研究"};t((async()=>{const e=a().query||{},t=(l?l().query:{}).id||e.id;if(P.value=t,t)console.log("从路由参数获取方案ID:",t),await q(t);else{try{const e=r("researchPlanHistory");if(e&&Array.isArray(e)&&e.length>0){const t=e[0].id;if(console.log("从本地存储获取最近的方案ID:",t),t)return P.value=t,void(await q(t))}}catch(o){console.error("获取本地存储的方案历史记录失败:",o)}console.log("未找到方案ID，尝试加载最新方案"),await z()}}));const q=async e=>{try{T.value=!0,console.log("开始加载研究方案详情, ID:",e);const a=await C(e);if(console.log("获取到研究方案数据:",a),!a)return console.error("研究方案数据为空"),T.value=!1,void(H.value=null);if(a.frameworkStr)try{console.log("尝试解析frameworkStr:",a.frameworkStr),a.framework=JSON.parse(a.frameworkStr)}catch(t){console.error("解析frameworkStr失败:",t),a.framework={}}else a.framework||(a.framework={});H.value=a,console.log("研究方案数据处理完成:",H.value),T.value=!1}catch(a){console.error("加载研究方案详情失败:",a),T.value=!1,H.value=null,o({title:"加载失败: "+a.message,icon:"none"})}},z=async()=>{try{T.value=!0,console.log("尝试加载用户最新研究方案");const a=await A();if(console.log("获取到用户研究方案列表:",a),!a||0===a.length)return console.log("用户没有研究方案"),T.value=!1,void(H.value=null);const l=a[0];if(console.log("获取到最新研究方案:",l),!l._id)return console.error("最新方案缺少ID"),T.value=!1,H.value=null,void o({title:"方案数据异常",icon:"none"});if(P.value=l._id,l.frameworkStr)try{console.log("尝试解析frameworkStr:",l.frameworkStr),l.framework=JSON.parse(l.frameworkStr)}catch(e){console.error("解析frameworkStr失败:",e),l.framework={}}else l.framework||(l.framework={});H.value=l,console.log("最新研究方案数据处理完成:",H.value);try{let e=r("researchPlanHistory")||[];Array.isArray(e)||(e=[]);const t=e.findIndex((e=>e.id===l._id));t>=0&&e.splice(t,1),e.unshift({id:l._id,title:l.title||"未命名方案",time:Date.now()}),e.length>10&&(e=e.slice(0,10)),n("researchPlanHistory",e),console.log("更新方案历史记录成功")}catch(t){console.error("保存方案历史记录失败:",t)}T.value=!1}catch(a){console.error("加载最新研究方案失败:",a),T.value=!1,H.value=null,o({title:"加载失败: "+a.message,icon:"none"})}},F=s((()=>{if(!H.value||!H.value.content)return"";try{let e=H.value.content;console.log("原始内容类型:",typeof e),console.log("原始内容长度:",e.length),console.log("原始内容前100个字符:",e.substring(0,100)),e=e.replace(/```markdown#?/gi,""),e=e.replace(/```\s*\w*/gi,""),e=e.replace(/```/g,""),e=e.replace(/^(#{1,6})([^\s])/gm,"$1 $2"),e=e.replace(/^([*\-+])([^\s])/gm,"$1 $2"),e=e.replace(/^(\d+\.)([^\s])/gm,"$1 $2"),e=e.replace(/^['"]+|['"]+$/g,""),e=e.replace(/^\s*markdown[#\s]*/i,""),e=e.replace(/\n([^#\s-])/g,"\n\n$1").replace(/([^\n])\n(#{1,6})/g,"$1\n\n$2").replace(/\n([\*\-+])/g,"\n\n$1").replace(/\n{3,}/g,"\n\n"),console.log("预处理后内容长度:",e.length),console.log("预处理后内容前100个字符:",e.substring(0,100));const t=require("marked");t.setOptions({gfm:!0,breaks:!0,headerIds:!0,mangle:!1,pedantic:!1,sanitize:!1,smartLists:!0,smartypants:!0});const a=t(e);console.log("HTML渲染后长度:",a.length);return a.replace(/<h1/g,'<h1 class="md-h1"').replace(/<h2/g,'<h2 class="md-h2"').replace(/<h3/g,'<h3 class="md-h3"').replace(/<h4/g,'<h4 class="md-h4"').replace(/<h5/g,'<h5 class="md-h5"').replace(/<h6/g,'<h6 class="md-h6"').replace(/<p>/g,'<p class="md-p">').replace(/<ul>/g,'<ul class="md-ul">').replace(/<ol>/g,'<ol class="md-ol">').replace(/<li>/g,'<li class="md-li">').replace(/<pre>/g,'<pre class="md-pre">').replace(/<code>/g,'<code class="md-code">')}catch(e){return console.error("Markdown渲染失败:",e),`<pre style="white-space: pre-wrap; word-wrap: break-word; padding: 16px; background: #f5f5f5; border-radius: 4px; font-family: monospace;">${H.value.content.replace(/```markdown#|```\s*\w*|```/g,"").replace(/^['"]+|['"]+$/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>`}})),M=async()=>{try{if(!H.value)return;if(v({title:"正在生成PDF...",mask:!0}),"undefined"==typeof document)throw new Error("当前不是Web环境，无法导出PDF");const a=document.createElement("div");a.className="plan-display export-container",a.style.width="100%",a.style.fontFamily="PingFang SC, Microsoft YaHei, sans-serif",a.style.backgroundColor="#ffffff",a.style.padding="20px",a.style.lineHeight="1.6";const l=document.createElement("div");l.style.textAlign="center",l.style.marginBottom="30px";const r=document.createElement("div");r.textContent=H.value.title,r.style.fontSize="24px",r.style.fontWeight="bold",r.style.marginBottom="15px",l.appendChild(r);const n=document.createElement("div");n.textContent=`关键词: ${J(H.value.keywords)}`,n.style.fontSize="14px",n.style.color="#666",l.appendChild(n);const s=document.createElement("div");s.style.marginTop="20px",s.style.marginBottom="30px",s.style.padding="15px",s.style.backgroundColor="#f8f9fa",s.style.borderRadius="6px";const c=document.createElement("div");c.textContent="研究目标:",c.style.fontWeight="bold",c.style.marginBottom="8px",s.appendChild(c);const i=document.createElement("div");i.textContent=H.value.objective||"无",i.style.color="#333",s.appendChild(i),l.appendChild(s),a.appendChild(l);const d=document.createElement("div");d.className="plan-content",d.style.fontSize="14px";try{let e=H.value.content;e=e.replace(/```markdown#?/gi,""),e=e.replace(/```\s*\w*/gi,""),e=e.replace(/```/g,""),e=e.replace(/^(#{1,6})([^\s])/gm,"$1 $2"),e=e.replace(/^([*\-+])([^\s])/gm,"$1 $2"),e=e.replace(/^(\d+\.)([^\s])/gm,"$1 $2"),e=e.replace(/^['"]+|['"]+$/g,""),e=e.replace(/^\s*markdown[#\s]*/i,""),e=e.replace(/\n([^#\s-])/g,"\n\n$1").replace(/([^\n])\n(#{1,6})/g,"$1\n\n$2").replace(/\n([\*\-+])/g,"\n\n$1").replace(/\n{3,}/g,"\n\n");const t=require("marked");t.setOptions({gfm:!0,breaks:!0,headerIds:!0,mangle:!1,pedantic:!1,sanitize:!1,smartLists:!0,smartypants:!0});const a=t(e);d.innerHTML=a;const l=(e,t,a,l,r="bold")=>{Array.from(d.querySelectorAll(e)).forEach((e=>{e.style.fontSize=t,e.style.marginTop=a,e.style.marginBottom=l,e.style.fontWeight=r,e.style.color="#333",e.style.pageBreakAfter="avoid",e.style.pageBreakInside="avoid"}))};l("h1","22px","28px","16px"),l("h2","20px","24px","14px"),l("h3","18px","20px","12px"),l("h4","16px","16px","10px"),Array.from(d.querySelectorAll("p")).forEach((e=>{e.style.margin="12px 0",e.style.lineHeight="1.6",e.style.color="#333"})),Array.from(d.querySelectorAll("ul, ol")).forEach((e=>{e.style.margin="12px 0",e.style.paddingLeft="24px"})),Array.from(d.querySelectorAll("li")).forEach((e=>{e.style.margin="6px 0",e.style.lineHeight="1.5"}))}catch(e){console.error("导出时Markdown渲染失败:",e),d.innerHTML=`<pre style="white-space: pre-wrap; word-wrap: break-word; padding: 16px; background: #f5f5f5; border-radius: 4px; font-family: monospace;">${H.value.content.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>`}a.appendChild(d);const p=document.createElement("div");p.style.marginTop="40px",p.style.paddingTop="15px",p.style.borderTop="1px solid #eee",p.style.textAlign="center",p.style.fontSize="12px",p.style.color="#999",p.textContent=`生成时间: ${N(H.value.createTime||new Date)}`,a.appendChild(p),document.body.appendChild(a);const u=`${H.value.title.substring(0,20)}_研究方案.pdf`;try{await D({element:a,filename:u,title:H.value.title,author:"教育研究助手",margins:{top:15,right:15,bottom:20,left:15},pageSize:"a4"}),w(),o({title:"导出成功",icon:"success"})}catch(t){console.error("导出PDF失败:",t),w(),o({title:"导出失败: "+t.message,icon:"none"})}finally{document.body.contains(a)&&document.body.removeChild(a)}}catch(e){console.error("导出操作失败:",e),w(),o({title:"导出失败: "+e.message,icon:"none"})}},B=()=>{H.value&&k({url:`/pages/researchPlanEditor/researchPlanEditor?id=${H.value._id}`})},L=()=>{H.value&&x({title:"确认删除",content:"确定要删除这个研究方案吗？此操作不可恢复。",success:async e=>{if(e.confirm)try{v({title:"正在删除...",mask:!0}),await E(H.value._id),w(),o({title:"删除成功",icon:"success"}),setTimeout((()=>{O()}),1500)}catch(t){console.error("删除研究方案失败:",t),w(),o({title:"删除失败: "+t.message,icon:"none"})}}})},O=()=>{b({delta:1})},N=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},J=e=>{if(!e)return"";if(!Array.isArray(e)){if("string"==typeof e)try{const t=JSON.parse(e);return Array.isArray(t)?t.join("、"):e}catch(t){return e}return String(e)}return e.filter((e=>e)).join("、")};return(e,t)=>{const a=d,l=_,r=$,o=S;return p(),c(a,{class:"research-plan-detail-container"},{default:i((()=>[T.value?(p(),c(a,{key:0,class:"loading-container"},{default:i((()=>[u(a,{class:"loading-spinner"}),u(l,{class:"loading-text"},{default:i((()=>[g("加载研究方案中...")])),_:1})])),_:1})):H.value?(p(),c(a,{key:2,class:"plan-content"},{default:i((()=>[u(a,{class:"plan-header"},{default:i((()=>[u(a,{class:"plan-title"},{default:i((()=>[g(m(H.value.title),1)])),_:1}),u(a,{class:"plan-meta"},{default:i((()=>[u(l,{class:"plan-type"},{default:i((()=>{return[g(m((e=H.value.templateType,I[e]||e)),1)];var e})),_:1}),u(l,{class:"plan-date"},{default:i((()=>[g("创建时间: "+m(N(H.value.createTime)),1)])),_:1})])),_:1}),u(a,{class:"plan-keywords"},{default:i((()=>[u(l,{class:"keywords-label"},{default:i((()=>[g("关键词:")])),_:1}),u(a,{class:"keywords-list"},{default:i((()=>[(p(!0),f(h,null,y(H.value.keywords,((e,t)=>(p(),c(l,{key:t,class:"keyword-tag"},{default:i((()=>[g(m(e),1)])),_:2},1024)))),128))])),_:1})])),_:1}),u(a,{class:"plan-objective"},{default:i((()=>[u(l,{class:"objective-label"},{default:i((()=>[g("研究目标:")])),_:1}),u(l,{class:"objective-content"},{default:i((()=>[g(m(H.value.objective),1)])),_:1})])),_:1})])),_:1}),u(a,{class:"plan-body"},{default:i((()=>[u(o,{class:"markdown-content",nodes:F.value},null,8,["nodes"])])),_:1}),u(a,{class:"plan-actions"},{default:i((()=>[u(r,{class:"action-button export-button",onClick:M},{default:i((()=>[g(" 导出为PDF ")])),_:1}),u(r,{class:"action-button edit-button",onClick:B},{default:i((()=>[g(" 编辑方案 ")])),_:1}),u(r,{class:"action-button delete-button",onClick:L},{default:i((()=>[g(" 删除方案 ")])),_:1})])),_:1})])),_:1})):(p(),c(a,{key:1,class:"error-container"},{default:i((()=>[u(l,{class:"error-text"},{default:i((()=>[g("加载失败，研究方案不存在或已被删除")])),_:1}),u(r,{class:"back-button",onClick:O},{default:i((()=>[g("返回列表")])),_:1})])),_:1}))])),_:1})}}},[["__scopeId","data-v-d2cde0e5"]]);export{T as default};
