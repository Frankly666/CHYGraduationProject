import{r as e,K as t,s as a,c as l,w as s,i as n,o as r,a as o,b as c,d as i,e as d,F as u,t as p,E as f,a0 as m,n as y,j as g,l as v,y as _,Q as h,g as k,x as w,q as b,v as x,O as C}from"./index-E3agI9Tn.js";import{g as S,d as P}from"./research-plan.CgVzqYui.js";import{e as $}from"./pdf-export.BKZ-eH5L.js";import{_ as A}from"./_plugin-vue_export-helper.BCo6x5W8.js";const j=A({__name:"researchPlanList",setup(A){const j=e(!0),D=e([]),E=e(1),T=e(10),F=e(0),I=e(1),M={experimental:"实验研究",survey:"调查研究","case-study":"案例研究","literature-review":"文献综述","action-research":"行动研究"};t((async()=>{await O()}));const O=async()=>{try{j.value=!0,console.log("开始加载研究方案列表, 页码:",E.value);const e=await S(E.value,T.value);if(console.log("获取到研究方案列表数据:",e),!e||!e.list)return console.error("研究方案列表数据为空或格式不正确"),D.value=[],F.value=0,I.value=1,void(j.value=!1);const t=e.list.filter((e=>e&&e._id)).map((e=>{if(!e)return null;try{if(e.frameworkStr)try{e.framework=JSON.parse(e.frameworkStr)}catch(t){console.error("解析frameworkStr失败:",t,e),e.framework={}}else e.framework||(e.framework={});return e}catch(a){return console.error("处理研究方案数据失败:",a,e),e}})).filter((e=>null!==e));D.value=t,F.value=e.total||0,I.value=e.totalPages||1,console.log("研究方案列表加载完成, 共",D.value.length,"条数据"),j.value=!1}catch(e){console.error("加载研究方案列表失败:",e),D.value=[],j.value=!1,a({title:"加载失败: "+e.message,icon:"none"})}},z=async e=>{e<1||e>I.value||(E.value=e,await O(),m({scrollTop:0,duration:300}))},H=e=>{if(!e)return console.error("缺少方案ID，无法查看详情"),void a({title:"方案数据异常",icon:"none"});console.log("跳转到方案详情页, ID:",e);try{let t=k("recentViewPlans")||[];Array.isArray(t)||(t=[]);const a=t.findIndex((t=>t===e));a>=0&&t.splice(a,1),t.unshift(e),t.length>10&&(t=t.slice(0,10)),w("recentViewPlans",t)}catch(t){console.error("保存最近查看记录失败:",t)}y({url:`/pages/researchPlanDetail/researchPlanDetail?id=${e}`})},L=()=>{y({url:"/pages/researchPlan/researchPlan"})},N=e=>{if(!e)return"";try{let t=e;t=t.replace(/^```markdown#/gm,""),t=t.replace(/^```/gm,""),t=t.replace(/^\s*```\s*\w*\s*$/m,"");const a=require("marked");return a.setOptions({gfm:!0,breaks:!0,headerIds:!0,mangle:!1}),a(t)}catch(t){return console.error("Markdown转HTML失败:",t),`<div style="white-space:pre-wrap;">${e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>`}},q=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},B=e=>{if(!e)return"";if(!Array.isArray(e)){if("string"==typeof e)try{const t=JSON.parse(e);return Array.isArray(t)?t.join("、"):e}catch(t){return e}return String(e)}return e.filter((e=>e)).join("、")};return(e,t)=>{const m=n,y=g,k=v,w=_;return r(),l(m,{class:"research-plan-list-container"},{default:s((()=>[o(m,{class:"header"},{default:s((()=>[o(m,{class:"title"},{default:s((()=>[c("我的研究方案")])),_:1}),o(m,{class:"subtitle"},{default:s((()=>[c("管理您生成的研究方案")])),_:1})])),_:1}),o(m,{class:"content"},{default:s((()=>[j.value?(r(),l(m,{key:0,class:"loading-container"},{default:s((()=>[o(m,{class:"loading-spinner"}),o(y,{class:"loading-text"},{default:s((()=>[c("加载研究方案中...")])),_:1})])),_:1})):0===D.value.length?(r(),l(m,{key:1,class:"empty-state"},{default:s((()=>[o(k,{class:"empty-image",src:"/static/images/empty-plans.png",mode:"aspectFit"}),o(y,{class:"empty-text"},{default:s((()=>[c("还没有创建研究方案")])),_:1}),o(w,{class:"create-button",onClick:L},{default:s((()=>[c("创建研究方案")])),_:1})])),_:1})):(r(),l(m,{key:2,class:"plan-list"},{default:s((()=>[(r(!0),i(u,null,d(D.value,((e,t)=>(r(),l(m,{key:e._id,class:"plan-card",onClick:t=>H(e._id)},{default:s((()=>[o(m,{class:"plan-card-header"},{default:s((()=>[o(y,{class:"plan-title"},{default:s((()=>[c(p(e.title),1)])),_:2},1024),o(y,{class:"plan-type"},{default:s((()=>{return[c(p((t=e.templateType,M[t]||t)),1)];var t})),_:2},1024)])),_:2},1024),o(m,{class:"plan-meta"},{default:s((()=>[o(y,{class:"plan-meta-item"},{default:s((()=>[o(y,{class:"plan-meta-label"},{default:s((()=>[c("关键词: ")])),_:1}),c(" "+p(B(e.keywords)),1)])),_:2},1024)])),_:2},1024),o(m,{class:"plan-actions"},{default:s((()=>[o(y,{class:"plan-time"},{default:s((()=>[c(p(q(e.createTime)),1)])),_:2},1024),o(m,{class:"action-buttons"},{default:s((()=>[o(w,{class:"action-btn view-btn",onClick:h((t=>H(e._id)),["stop"])},{default:s((()=>[c("查看")])),_:2},1032,["onClick"]),o(w,{class:"action-btn export-btn",onClick:h((t=>(async e=>{try{b({title:"准备导出...",mask:!0});const l=document.createElement("div");l.className="plan-display export-container",l.style.width="100%",l.style.fontFamily="PingFang SC, Microsoft YaHei, sans-serif",l.style.backgroundColor="#ffffff",l.style.padding="20px";const s=document.createElement("div");s.style.textAlign="center",s.style.marginBottom="30px";const n=document.createElement("div");n.textContent=e.title,n.style.fontSize="24px",n.style.fontWeight="bold",n.style.marginBottom="15px",s.appendChild(n);const r=document.createElement("div");r.textContent=`关键词: ${B(e.keywords)}`,r.style.fontSize="14px",r.style.color="#666",s.appendChild(r),l.appendChild(s);const o=document.createElement("div");o.innerHTML=N(e.content),l.appendChild(o);const c=document.createElement("div");c.style.marginTop="40px",c.style.textAlign="center",c.style.fontSize="12px",c.style.color="#999",c.textContent=`生成时间: ${q(e.createTime)}`,l.appendChild(c),document.body.appendChild(l);const i=`${e.title.substring(0,20)}_研究方案.pdf`;try{await $({element:l,filename:i,title:e.title,author:"教育研究助手"}),x(),a({title:"导出成功",icon:"success"})}catch(t){console.error("导出PDF失败:",t),x(),a({title:"导出失败: "+t.message,icon:"none"})}finally{document.body.contains(l)&&document.body.removeChild(l)}}catch(l){console.error("导出操作失败:",l),x(),a({title:"导出失败: "+l.message,icon:"none"})}})(e)),["stop"])},{default:s((()=>[c("导出")])),_:2},1032,["onClick"]),o(w,{class:"action-btn delete-btn",onClick:h((l=>((e,t)=>{C({title:"确认删除",content:"确定要删除这个研究方案吗？此操作不可恢复。",success:async l=>{if(l.confirm)try{b({title:"正在删除...",mask:!0}),await P(e),D.value.splice(t,1),x(),a({title:"删除成功",icon:"success"}),0===D.value.length&&E.value>1?await z(E.value-1):0===D.value.length&&await O()}catch(s){console.error("删除研究方案失败:",s),x(),a({title:"删除失败: "+s.message,icon:"none"})}}})})(e._id,t)),["stop"])},{default:s((()=>[c("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})),I.value>1?(r(),l(m,{key:3,class:"pagination"},{default:s((()=>[o(w,{class:"pagination-btn",disabled:1===E.value,onClick:t[0]||(t[0]=e=>z(E.value-1))},{default:s((()=>[c(" 上一页 ")])),_:1},8,["disabled"]),o(y,{class:"pagination-info"},{default:s((()=>[c(p(E.value)+"/"+p(I.value),1)])),_:1}),o(w,{class:"pagination-btn",disabled:E.value===I.value,onClick:t[1]||(t[1]=e=>z(E.value+1))},{default:s((()=>[c(" 下一页 ")])),_:1},8,["disabled"])])),_:1})):f("",!0)])),_:1})])),_:1})}}},[["__scopeId","data-v-2a594a06"]]);export{j as default};
